# AWS Application Load Balancer Module

## Overview
This module creates PSA-compliant AWS Application Load Balancers with HTTPS enforcement, access logging, and WAF integration.

## Features
- HTTPS-first configuration with SSL/TLS termination
- Automatic HTTP to HTTPS redirection
- S3 access logs with encryption
- WAF Web ACL association support
- Multiple target groups with custom routing rules
- Health checks with configurable parameters
- PSA-compliant security settings

## Usage
```hcl
module "aws-alb" {
  source = "./terraform-aws-alb"

  name_prefix = "myapp"
  vpc_id = "vpc-123456"
  subnet_ids = ["subnet-123", "subnet-456"]
  security_group_ids = ["sg-789"]
  certificate_arn = "arn:aws:acm:region:account:certificate/cert-id"
  
  # Target configuration
  target_port = 8080
  target_protocol = "HTTP"
  
  tags = {
    "Environment" = "production"
  }
}
```

## Security Features
- HTTPS enforcement with modern SSL policies
- HTTP redirects to HTTPS (301 permanent)
- WAF fail-closed configuration
- Invalid header fields are dropped
- S3 access logs with server-side encryption
- Public access blocked on log buckets

## Target Group Support
- Default target group for primary application
- Additional target groups with custom routing
- Host header and path pattern routing
- Configurable health checks per target group

## PSA Compliance
- HTTPS-only traffic enforcement
- Encrypted access logging
- WAF integration ready
- Security headers enforced
- No public S3 bucket access
<!-- BEGIN_TF_DOCS -->


_<-- This file is autogenerated, please do not change. -->_

## Requirements

| Name | Version |
|------|---------|
| terraform | >=1.3 |
| aws | ~> 6.0 |

## Providers

| Name | Version |
|------|---------|
| aws | 6.7.0 |

## Resources

| Name | Type |
|------|------|
| [aws_lb.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb) | resource |
| [aws_lb_listener.http_redirect](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener) | resource |
| [aws_lb_listener.https](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener) | resource |
| [aws_lb_listener_rule.additional](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener_rule) | resource |
| [aws_lb_target_group.additional](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group) | resource |
| [aws_lb_target_group.default](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group) | resource |
| [aws_s3_bucket.alb_logs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket) | resource |
| [aws_s3_bucket_policy.alb_logs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_policy) | resource |
| [aws_s3_bucket_public_access_block.alb_logs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_public_access_block) | resource |
| [aws_s3_bucket_server_side_encryption_configuration.alb_logs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_server_side_encryption_configuration) | resource |
| [aws_s3_bucket_versioning.alb_logs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_versioning) | resource |
| [aws_wafv2_web_acl_association.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/wafv2_web_acl_association) | resource |
| [aws_elb_service_account.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/elb_service_account) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| certificate_arn | ARN of the SSL certificate for HTTPS listener | `string` | n/a | yes |
| environment | Environment (e.g., prod, dev, test) | `string` | n/a | yes |
| project_name | Name of the project | `string` | n/a | yes |
| security_group_ids | List of security group IDs for the ALB | `list(string)` | n/a | yes |
| subnet_ids | List of subnet IDs for the ALB | `list(string)` | n/a | yes |
| vpc_id | VPC ID where the ALB will be created | `string` | n/a | yes |
| access_logs_bucket | S3 bucket name for ALB access logs (required if enable_access_logs=true and create_logs_bucket=false) | `string` | `""` | no |
| access_logs_prefix | S3 prefix for ALB access logs | `string` | `"alb-access-logs"` | no |
| additional_target_groups | Additional target groups to create | <pre>map(object({<br/>    port                             = number<br/>    protocol                         = string<br/>    priority                         = number<br/>    host_header                      = optional(string)<br/>    path_pattern                     = optional(string)<br/>    health_check_healthy_threshold   = optional(number)<br/>    health_check_interval            = optional(number)<br/>    health_check_matcher             = optional(string)<br/>    health_check_path                = optional(string)<br/>    health_check_timeout             = optional(number)<br/>    health_check_unhealthy_threshold = optional(number)<br/>    deregistration_delay             = optional(number)<br/>  }))</pre> | `{}` | no |
| create_http_listener | Create HTTP listener that redirects to HTTPS | `bool` | `true` | no |
| create_logs_bucket | Create S3 bucket for ALB access logs | `bool` | `false` | no |
| deregistration_delay | Amount of time, in seconds, for targets to drain connections during deregistration | `number` | `300` | no |
| enable_access_logs | Enable access logs for the ALB | `bool` | `false` | no |
| enable_cross_zone_load_balancing | Enable cross-zone load balancing | `bool` | `true` | no |
| enable_deletion_protection | Enable deletion protection for the ALB | `bool` | `true` | no |
| enable_http2 | Enable HTTP/2 support | `bool` | `true` | no |
| health_check_healthy_threshold | Number of consecutive health check successes required before considering a target healthy | `number` | `3` | no |
| health_check_interval | Approximate amount of time, in seconds, between health checks | `number` | `30` | no |
| health_check_matcher | Response codes to use when checking for a healthy responses from a target | `string` | `"200"` | no |
| health_check_path | Destination for health checks | `string` | `"/"` | no |
| health_check_timeout | Amount of time, in seconds, during which no response from a target means a failed health check | `number` | `5` | no |
| health_check_unhealthy_threshold | Number of consecutive health check failures required before considering a target unhealthy | `number` | `2` | no |
| internal | Whether the ALB is internal (true) or internet-facing (false) | `bool` | `false` | no |
| name_prefix | Prefix for resource names (if not provided, will use project-environment pattern) | `string` | `""` | no |
| ssl_policy | SSL policy for HTTPS listener | `string` | `"ELBSecurityPolicy-TLS-1-2-2017-01"` | no |
| tags | Additional tags for all resources | `map(string)` | `{}` | no |
| target_port | Port for the default target group | `number` | `80` | no |
| target_protocol | Protocol for the default target group | `string` | `"HTTP"` | no |
| waf_web_acl_arn | ARN of the WAF Web ACL to associate with the ALB | `string` | `""` | no |

## Outputs

| Name | Description |
|------|-------------|
| additional_target_group_arns | Map of additional target group names to their ARNs |
| additional_target_group_ids | Map of additional target group names to their IDs |
| alb_arn | ARN of the Application Load Balancer |
| alb_dns_name | DNS name of the Application Load Balancer |
| alb_id | ID of the Application Load Balancer |
| alb_zone_id | Hosted zone ID of the Application Load Balancer |
| default_target_group_arn | ARN of the default target group |
| default_target_group_id | ID of the default target group |
| http_listener_arn | ARN of the HTTP listener (if created) |
| https_listener_arn | ARN of the HTTPS listener |
| s3_bucket_arn | ARN of the S3 bucket for ALB access logs (if created) |
| s3_bucket_name | Name of the S3 bucket for ALB access logs (if created) |

## Examples

Minimal configuration to install the desired resources with the module

```hcl
module "tpl_module" {
  source = "tpl_source"
  tpl_local_name = {
    tpl_name = {
      location            = "westeurope"
      resource_group_name = "rg-mms-github"
    }
  }
}
```

Advanced configuration to install the desired resources with the module

```hcl
module "tpl_module" {
  source = "tpl_source"
  tpl_local_name = {
    tpl_name = {
      location            = "westeurope"
      resource_group_name = "rg-mms-github"
      tags = {
        project     = "mms-github"
        environment = terraform.workspace
        managed-by  = "terraform"
      }
    }
  }
}
```
<!-- END_TF_DOCS -->